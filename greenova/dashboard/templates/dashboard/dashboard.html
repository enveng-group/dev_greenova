{% extends base_template|default:"base.html" %} {% load static dashboard_tags
partials hyperscript project_tags %} {% block title %} Dashboard {% endblock
title %} {% block body %}
<article hx-ext="class-tools path-deps" classes="add fade-in">
  {% partialdef dashboard_header %}
  <header hx-ext="class-tools" classes="add slide-in-from-top:0.3s">
    <hgroup>
      <h1>Hi {{ request.user|display_name }}</h1>
      <h2>Environmental Compliance Dashboard</h2>
    </hgroup>
  </header>
  {% endpartialdef dashboard_header %} {% partialdef project_selection %}
  <!-- Project Selection -->
  {% include "projects/projects_selector.html" %} {% endpartialdef
  project_selection %} {% if projects %} {% with
  project_list=projects|map:"to_dict"|to_list %} {% hs_dump project_list
  'availableProjects' scope='element' %} {% endwith %} {% hs_dump user_roles
  'userRoles' scope='element' %} {% endif %} {% partialdef data_container %}
  <!-- Data Container -->
  <div
    class="project-data-container"
    hx-ext="class-tools"
    classes="add fade-in:0.5s"
    _="on projectChanged(projectId) add .loading to me fetch `/obligations/summary/?project_id=${projectId}` as response remove .loading from me"
  >
    <div data-loading="block" style="text-align: center; padding: 2rem">
      <div class="loading-spinner" aria-busy="true">
        Loading project data...
      </div>
    </div>
    <div id="obligations-container"></div>
  </div>
  {% endpartialdef data_container %} {% partialdef overdue_card %}
  <!-- Overdue obligations card -->
  <div
    class="stat-card overdue"
    hx-ext="class-tools path-deps"
    path-deps="/obligations/"
    hx-trigger="path-deps"
    _="on highOverdueCount add .warning to me else remove .warning from me end"
  >
    <h3>Overdue Obligations</h3>
    <span
      class="count"
      hx-get="{% url 'dashboard:overdue_count' %}"
      hx-trigger="load, projectChanged from:body"
    >
      <div aria-busy="true">...</div>
    </span>
  </div>
  {% endpartialdef overdue_card %}
  <!-- Now use the defined partials -->
  {% partial dashboard_header %} {% partial project_selection %} {% partial
  data_container %} {% partial overdue_card %}
</article>
<!-- Add script to initialize project selection and data loading -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const projectSelector = document.getElementById('project-selector');
    if (projectSelector && projectSelector.options.length > 0) {
      // Trigger initial data loading with first project
      const initialProjectId = projectSelector.value;
      if (initialProjectId) {
        document.body.dispatchEvent(
          new CustomEvent('projectChanged', {
            detail: { projectId: initialProjectId },
          })
        );
      }
    }
  });
</script>
{% endblock body %} {% block footer %}
<footer role="contentinfo" hx-ext="class-tools" classes="add fade-in:1s">
  <div class="container">
    <p>
      Â© {% now "Y" %} Enveng Group - Environmental Compliance Management
      System
    </p>
    <p>Version: {{ site_version|default:"0.0.4" }}</p>
  </div>
</footer>
{{ block.super }} {% endblock footer %}
