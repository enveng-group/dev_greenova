{% load obligation_tags %}

<section aria-labelledby="obligations-heading" class="obligations-section">
  <h2 id="obligations-heading">Obligations Overview</h2>

  {% if error %}
    <div class="notice error" role="alert">
      <p>{{ error }}</p>
    </div>
  {% else %}
    <!-- Hidden project ID that will be included in all requests -->
    <input type="hidden" name="project_id" value="{{ project_id }}">

    <!-- Filter and Search Controls -->
    <div class="filter-section" aria-labelledby="filter-heading">
      <div class="filter-header">
        <h3 id="filter-heading">Filter and Sort</h3>
        <details>
          <summary role="button">Filters</summary>
          <div class="controls-container">
            <!-- Search Bar -->
            <div class="search-control">
              <label for="obligation-search">Search:</label>
              <input type="search"
                     id="obligation-search"
                     name="search"
                     placeholder="Search obligations..."
                     value="{{ active_filters.search }}"
                     hx-get="{% url 'obligations:summary' %}"
                     hx-trigger="keyup changed delay:500ms"
                     hx-target=".obligations-section"
                     hx-push-url="true">
            </div>

            <!-- Filter Controls -->
            <fieldset class="filter-fieldset">
              <legend>Filter By:</legend>

              <div class="filter-group">
                <label for="status-filter">Status:</label>
                <select id="status-filter"
                        name="status"
                        multiple
                        hx-get="{% url 'obligations:summary' %}"
                        hx-trigger="change"
                        hx-target=".obligations-section"
                        hx-push-url="true"
                        aria-label="Filter by status">
                  <option value="">All Statuses</option>
                  {% for status in filter_options.status %}
                    <option value="{{ status }}"
                            {% if status in active_filters.status %}selected{% endif %}>
                      {{ status|title }}
                    </option>
                  {% endfor %}
                </select>
              </div>

              <div class="filter-group">
                <label for="mechanism-filter">Mechanism:</label>
                <select id="mechanism-filter"
                        name="mechanism"
                        multiple
                        hx-get="{% url 'obligations:summary' %}"
                        hx-trigger="change"
                        hx-target=".obligations-section"
                        hx-push-url="true"
                        aria-label="Filter by mechanism">
                  <option value="">All Mechanisms</option>
                  {% for mechanism in filter_options.mechanism %}
                    <option value="{{ mechanism }}"
                            {% if mechanism in active_filters.mechanism %}selected{% endif %}>
                      {{ mechanism }}
                    </option>
                  {% endfor %}
                </select>
              </div>

              <div class="filter-group">
                <label for="phase-filter">Phase:</label>
                <select id="phase-filter"
                        name="phase"
                        multiple
                        hx-get="{% url 'obligations:summary' %}"
                        hx-trigger="change"
                        hx-target=".obligations-section"
                        hx-push-url="true"
                        aria-label="Filter by project phase">
                  <option value="">All Phases</option>
                  {% for phase in filter_options.phase %}
                    <option value="{{ phase }}"
                            {% if phase in active_filters.phase %}selected{% endif %}>
                      {{ phase }}
                    </option>
                  {% endfor %}
                </select>
              </div>
            </fieldset>

            <!-- Sort Controls -->
            <fieldset class="sort-fieldset">
              <legend>Sort By:</legend>

              <div class="sort-group">
                <label for="sort-field">Field:</label>
                <select id="sort-field"
                        name="sort"
                        hx-get="{% url 'obligations:summary' %}"
                        hx-trigger="change"
                        hx-target=".obligations-section"
                        hx-push-url="true"
                        aria-label="Sort by field">
                  {% for sort in sort_options %}
                    <option value="{{ sort.field }}"
                            {% if sort.field == active_filters.sort %}selected{% endif %}>
                      {{ sort.label }}
                    </option>
                  {% endfor %}
                </select>
              </div>

              <div class="sort-group">
                <label for="sort-order">Order:</label>
                <select id="sort-order"
                        name="order"
                        hx-get="{% url 'obligations:summary' %}"
                        hx-trigger="change"
                        hx-target=".obligations-section"
                        hx-push-url="true"
                        aria-label="Sort order">
                  <option value="asc" {% if active_filters.order == 'asc' %}selected{% endif %}>
                    Ascending
                  </option>
                  <option value="desc" {% if active_filters.order == 'desc' %}selected{% endif %}>
                    Descending
                  </option>
                </select>
              </div>
            </fieldset>
          </div>
        </details>
      </div>

      <!-- Active Filters Display -->
      {% if active_filters.search or active_filters.status or active_filters.mechanism or active_filters.phase %}
        <div class="active-filters" aria-label="Active filters">
          <small>Active filters:</small>
          {% if active_filters.search %}
            <span class="filter-tag">
              Search: {{ active_filters.search }}
              <button type="button"
                      hx-get="{% url 'obligations:summary' %}?project_id={{ project_id }}"
                      hx-target=".obligations-section"
                      hx-push-url="true"
                      _="on click set #obligation-search.value to ''"
                      aria-label="Clear search filter">
                ×
              </button>
            </span>
          {% endif %}

          {% for status in active_filters.status %}
            <span class="filter-tag">
              Status: {{ status|title }}
              <button type="button"
                      hx-get="{% url 'obligations:summary' %}?project_id={{ project_id }}&{% for s in active_filters.status %}{% if s != status %}status={{ s }}&{% endif %}{% endfor %}{% for m in active_filters.mechanism %}mechanism={{ m }}&{% endfor %}{% for p in active_filters.phase %}phase={{ p }}&{% endfor %}{% if active_filters.search %}search={{ active_filters.search }}&{% endif %}sort={{ active_filters.sort }}&order={{ active_filters.order }}"
                      hx-target=".obligations-section"
                      hx-push-url="true"
                      aria-label="Remove {{ status }} status filter">
                ×
              </button>
            </span>
          {% endfor %}

          {% for mechanism in active_filters.mechanism %}
            <span class="filter-tag">
              Mechanism: {{ mechanism }}
              <button type="button"
                      hx-get="{% url 'obligations:summary' %}?project_id={{ project_id }}&{% for s in active_filters.status %}status={{ s }}&{% endfor %}{% for m in active_filters.mechanism %}{% if m != mechanism %}mechanism={{ m }}&{% endif %}{% endfor %}{% for p in active_filters.phase %}phase={{ p }}&{% endfor %}{% if active_filters.search %}search={{ active_filters.search }}&{% endif %}sort={{ active_filters.sort }}&order={{ active_filters.order }}"
                      hx-target=".obligations-section"
                      hx-push-url="true"
                      aria-label="Remove {{ mechanism }} mechanism filter">
                ×
              </button>
            </span>
          {% endfor %}

          {% for phase in active_filters.phase %}
            <span class="filter-tag">
              Phase: {{ phase }}
              <button type="button"
                      hx-get="{% url 'obligations:summary' %}?project_id={{ project_id }}&{% for s in active_filters.status %}status={{ s }}&{% endfor %}{% for m in active_filters.mechanism %}mechanism={{ m }}&{% endfor %}{% for p in active_filters.phase %}{% if p != phase %}phase={{ p }}&{% endif %}{% endfor %}{% if active_filters.search %}search={{ active_filters.search }}&{% endif %}sort={{ active_filters.sort }}&order={{ active_filters.order }}"
                      hx-target=".obligations-section"
                      hx-push-url="true"
                      aria-label="Remove {{ phase }} phase filter">
                ×
              </button>
            </span>
          {% endfor %}
        </div>
      {% endif %}
    </div>

    <!-- Table Container with Scrolling Support -->
    <div class="table-container">
      <!-- Horizontal Scroll Indicator -->
      <div class="horizontal-scroll" id="scroll-indicator"
           role="scrollbar"
           aria-controls="obligations-table"
           aria-orientation="horizontal">
        <div class="scroll-indicator">
          <div class="scroll-thumb"></div>
        </div>
      </div>

      <!-- Results Count -->
      <div class="results-count">
        <small>Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} of {{ page_obj.paginator.count }} obligations</small>
      </div>

      <!-- Scrollable Table Content -->
      <div class="horizontal-scroll">
        <table role="grid" id="obligations-table">
          <thead>
            <tr>
              <th scope="col">ID</th>
              <th scope="col">Mechanism</th>
              <th scope="col">Procedure</th>
              <th scope="col">Environmental Aspect</th>
              <th scope="col">Obligation</th>
              <th scope="col">Action Due Date</th>
              <th scope="col">Close Out Date</th>
              <th scope="col">Status</th>
              <th scope="col">Accountability</th>
              <th scope="col">Responsibility</th>
              <th scope="col">Project Phase</th>
              <th scope="col">Supporting Info</th>
              <th scope="col">General Comments</th>
              <th scope="col">Compliance Comments</th>
              <th scope="col">Non-Conformance</th>
              <th scope="col">Evidence</th>
              <th scope="col">Contact Email</th>
              <th scope="col">Site/Desktop</th>
              <th scope="col">New Control Action</th>
              <th scope="col">Obligation Type</th>
              <th scope="col">Gap Analysis</th>
              <th scope="col">Gap Analysis Notes</th>
              <th scope="col">Inspection Checklist</th>
            </tr>
          </thead>
          <tbody>
            {% for obligation in obligations %}
              <tr>
                <td>{{ obligation.obligation_number }}</td>
                <td>{{ obligation.primary_environmental_mechanism.name }}</td>
                <td>{{ obligation.procedure|default:"-" }}</td>
                <td>{{ obligation.environmental_aspect }}</td>
                <td>{{ obligation.obligation|truncatewords:30 }}</td>
                <td>{{ obligation.action_due_date|format_due_date }}</td>
                <td>{{ obligation.close_out_date|default:"-" }}</td>
                <td>{% status_badge obligation.status %}</td>
                <td>{{ obligation.accountability }}</td>
                <td>{{ obligation.responsibility }}</td>
                <td>{{ obligation.project_phase|default:"-" }}</td>
                <td>{{ obligation.supporting_information|default:"-"|truncatewords:20 }}</td>
                <td>{{ obligation.general_comments|default:"-"|truncatewords:20 }}</td>
                <td>{{ obligation.compliance_comments|default:"-"|truncatewords:20 }}</td>
                <td>{{ obligation.non_conformance_comments|default:"-"|truncatewords:20 }}</td>
                <td>{{ obligation.evidence|default:"-" }}</td>
                <td>{{ obligation.person_email|default:"-" }}</td>
                <td>{{ obligation.site_or_desktop|default:"-" }}</td>
                <td>{{ obligation.new_control_action_required|yesno:"Yes,No" }}</td>
                <td>{{ obligation.obligation_type|default:"-" }}</td>
                <td>{{ obligation.gap_analysis|default:"-"|truncatewords:20 }}</td>
                <td>{{ obligation.notes_for_gap_analysis|default:"-"|truncatewords:20 }}</td>
                <td>{{ obligation.covered_in_which_inspection_checklist|default:"-" }}</td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="23" class="centered-message">No obligations match your criteria.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Pagination Controls -->
      <nav class="pagination" aria-label="Obligations pagination">
        <ul class="pagination-list">
          {% if page_obj.has_previous %}
            <li>
              <a href="#"
                 hx-get="{% url 'obligations:summary' %}?project_id={{ project_id }}&page={{ page_obj.previous_page_number }}{% for status in active_filters.status %}&status={{ status }}{% endfor %}{% for mechanism in active_filters.mechanism %}&mechanism={{ mechanism }}{% endfor %}{% for phase in active_filters.phase %}&phase={{ phase }}{% endfor %}{% if active_filters.search %}&search={{ active_filters.search }}{% endif %}&sort={{ active_filters.sort }}&order={{ active_filters.order }}"
                 hx-target=".obligations-section"
                 hx-swap="outerHTML"
                 rel="prev"
                 aria-label="Previous page">
                Previous
              </a>
            </li>
          {% endif %}

          <li>
            <span class="pagination-info">
              Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
            </span>
          </li>

          {% if page_obj.has_next %}
            <li>
              <a href="#"
                 hx-get="{% url 'obligations:summary' %}?project_id={{ project_id }}&page={{ page_obj.next_page_number }}{% for status in active_filters.status %}&status={{ status }}{% endfor %}{% for mechanism in active_filters.mechanism %}&mechanism={{ mechanism }}{% endfor %}{% for phase in active_filters.phase %}&phase={{ phase }}{% endfor %}{% if active_filters.search %}&search={{ active_filters.search }}{% endif %}&sort={{ active_filters.sort }}&order={{ active_filters.order }}"
                 hx-target=".obligations-section"
                 hx-swap="outerHTML"
                 rel="next"
                 aria-label="Next page">
                Next
              </a>
            </li>
          {% endif %}
        </ul>
      </nav>
    </div>
  {% endif %}
</section>

<style>
  /* Improved filter and sort layout */
  .filter-section {
    margin-bottom: 1.5rem;
  }

  .filter-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
  }

  .filter-header h3 {
    margin: 0;
    font-size: 1rem;
  }

  .controls-container {
    display: grid;
    gap: 1rem;
    margin: 1rem 0;
    grid-template-columns: 1fr;
  }

  @media (min-width: 768px) {
    .controls-container {
      grid-template-columns: 1fr 2fr;
    }
  }

  .search-control {
    display: flex;
    flex-direction: column;
  }

  .search-control label {
    margin-bottom: 0.25rem;
    font-size: 0.875rem;
  }

  .filter-fieldset, .sort-fieldset {
    padding: 0.75rem;
    border-radius: var(--border-radius);
    border: 1px solid var(--border-color);
  }

  .filter-fieldset legend, .sort-fieldset legend {
    font-size: 0.875rem;
    padding: 0 0.5rem;
  }

  .filter-group, .sort-group {
    display: flex;
    flex-direction: column;
    margin-bottom: 0.75rem;
  }

  .filter-group:last-child, .sort-group:last-child {
    margin-bottom: 0;
  }

  .filter-group label, .sort-group label {
    margin-bottom: 0.25rem;
    font-size: 0.875rem;
  }

  @media (min-width: 992px) {
    .filter-fieldset {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
    }

    .filter-group {
      margin-bottom: 0;
    }

    .sort-fieldset {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
    }
  }

  /* Active filters */
  .active-filters {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    align-items: center;
    margin-top: 0.75rem;
  }

  .active-filters small {
    color: var(--text-muted);
  }

  .filter-tag {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.5rem;
    background: var(--background-alt);
    border-radius: var(--border-radius);
    font-size: 0.75rem;
  }

  .filter-tag button {
    border: none;
    background: none;
    padding: 0;
    margin: 0;
    cursor: pointer;
    font-size: 1rem;
    line-height: 1;
    color: var(--text-muted);
  }

  .filter-tag button:hover {
    color: var(--text);
  }

  /* Results count */
  .results-count {
    margin-bottom: 0.5rem;
    color: var(--text-muted);
    text-align: right;
  }

  /* Empty state */
  .centered-message {
    text-align: center;
    padding: 2rem;
    color: var(--text-muted);
  }
</style>
